"use strict";(self.webpackChunkmmsp_station=self.webpackChunkmmsp_station||[]).push([[11668,73814],{11668:(e,t,r)=>{r.d(t,{K:()=>d,Q:()=>l});var a=r(31933),n=r(67061);const s=new Set(["Catalog Layer","Feature Layer","Oriented Imagery Layer"]);async function l(e,t){const{loadContext:r,...s}=t||{},l=r?await r.fetchServiceMetadata(e,s):await(0,n.V)(e,s),o=(0,a.G$)();p(l),i(l);const u={serviceJSON:l,preferredHost:o};if((l.currentVersion??0)<10.5)return u;const c=`${(0,a.$x)()??e}/layers`,y=r?await r.fetchServiceMetadata(c,s):await(0,n.V)(c,s);return p(y),i(y),u.layersJSON={layers:y.layers,tables:y.tables},u}function o(e){const{type:t}=e;return!!t&&s.has(t)}function u(e){return"Table"===e.type}function i(e){e.layers=e.layers?.filter(o),e.tables=e.tables?.filter(u)}function c(e){e.type||="Feature Layer"}function y(e){e.type||="Table"}function p(e){e.layers?.forEach(c),e.tables?.forEach(y)}function d(e){switch(e){case"Feature Layer":case"Table":return"FeatureLayer";case"Oriented Imagery Layer":return"OrientedImageryLayer";case"Catalog Layer":return"CatalogLayer"}return"FeatureLayer"}},64130:(e,t,r)=>{r.d(t,{Ju:()=>c,K8:()=>d,XH:()=>y,_r:()=>l,bO:()=>o,l:()=>p,nu:()=>f,pJ:()=>u,rc:()=>i});var a=r(39323),n=r(11668),s=r(31933);function l(e){const t={id:e.id,name:e.name},r=(0,n.K)(e.type);return"FeatureLayer"!==r&&(t.layerType=r),t}async function o(e,t,r){let a;if(null==e?.layers||null==e?.tables){const n=await r.fetchServiceMetadata(t,{customParameters:u(e)?.customParameters});a=(0,s.G$)(),(e=e||{}).layers=e.layers||n?.layers?.map(l),e.tables=e.tables||n?.tables?.map(l)}return{data:e,preferredHost:a}}function u(e){if(!e)return null;const{layers:t,tables:r}=e;return t?.length?t[0]:r?.length?r[0]:null}function i(e,t){return null==t?null:[...e.layers||[],...e.tables||[]].find(e=>e.id===t)}function c(e,t){return[...e.layers||[],...e.tables||[]].filter(e=>{let{layerType:r}=e;return r?t.includes(r):t.includes("ArcGISFeatureLayer")})}function y(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function p(e){switch(e){case"catalog":return["CatalogLayer"];case"feature":return["ArcGISFeatureLayer"];case"oriented-imagery":return["OrientedImageryLayer"];case"subtype-group":return["SubtypeGroupLayer","SubtypeGroupTable"]}return null}function d(e){switch(e){case"CatalogLayer":return"CatalogLayer";case"OrientedImageryLayer":return"OrientedImageryLayer";case"SubtypeGroupLayer":case"SubtypeGroupTable":return"SubtypeGroupLayer"}return"FeatureLayer"}async function f(e,t,r){if(!e?.url)return t??{};if(t??={},!t.layers){const a=await r.fetchServiceMetadata(e.url);t.layers=a.layers?.map(l)}const{serverUrl:n,portalItem:s}=await(0,a.L)(e.url,{sceneLayerItem:e,customParameters:u(t)?.customParameters}).catch(()=>({serverUrl:null,portalItem:null}));if(null==n)return t.tables=[],t;if(!t.tables&&s){const e=await s.fetchData().catch(()=>null);if(e?.tables)t.tables=e.tables.map(l);else{const a=await r.fetchServiceMetadata(n,{customParameters:u(e)?.customParameters}).catch(()=>null);t.tables=a?.tables?.map(l)}}if(t.tables)for(const a of t.tables)a.url=`${n}/${a.id}`;return t}},67061:(e,t,r)=>{r.d(t,{V:()=>n});var a=r(3825);async function n(e,t){const{data:r}=await(0,a.A)(e,{responseType:"json",query:{f:"json",...t?.customParameters,token:t?.apiKey}});return r}},73814:(e,t,r)=>{r.d(t,{load:()=>f});var a=r(50076),n=r(13096),s=r(11668),l=r(77491),o=r(31933),u=r(44568),i=r(79942),c=r(64130),y=r(72945),p=r(81589),d=r(67061);async function f(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),function(e){const t=e.instance.portalItem;if(!t?.type||!e.supportedTypes.includes(t.type))throw new a.A("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:t?.type,expectedType:e.supportedTypes.join(", ")})}(e),e.validateItem&&e.validateItem(r),async function(e,t){const r=e.instance,n=r.portalItem;if(!n)return;let{url:u}=n;const{title:f}=n,h=(0,i.v)(n,"portal-item");if("group"===r.type)return async function(e,t,r){const n=e.portalItem;if(!e.sourceIsPortalItem)return;const{title:u,type:p}=n;if("Group Layer"===p){if(!(0,y.Y)(n,"Map"))throw new a.A("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return async function(e,t){const r=e.portalItem,n=await r.fetchData("json");if(!n)return;if(!t.populateGroupLayer)throw new a.A("portal:missing-populate-group-layer","Missing populate group layer");const s=(0,i.v)(r,"web-map");e.read(n,s),await t.populateGroupLayer(e,n,{context:s}),e.resourceReferences={portalItem:r,paths:s.readResourcePaths??[]}}(e,r)}return e.read({title:u},t),async function(e,t){let r;const{portalItem:n}=e;if(!n)return;const u=n.type,i=t.layerModuleTypeMap;if(!i)throw new a.A("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(u){case"Feature Service":case"Feature Collection":r=i.FeatureLayer;break;case"Stream Service":r=i.StreamLayer;break;case"Scene Service":r=i.SceneLayer;break;case"Video Service":r=i.VideoLayer;break;default:throw new a.A("portal:unsupported-item-type-as-group",`The item type '${u}' is not supported as a 'GroupLayer'`)}const y="Video Service"===u,p=new l.v;let[f,{data:h}]=await Promise.all([r(),y?{data:null}:w(t,p)]),b=()=>f;if(y)return async function(e,t,r){const{portalItem:a}=e;if(!a?.url)return;const n=await(0,d.V)(a.url);n&&m(e,t,null,{layers:n.layers?.map(e=>{let{id:t,name:r}=e;return{id:t,name:r}})},r)}(e,b,i);if("Feature Service"===u){const t=(0,c.pJ)(h)?.customParameters;h=n.url?(await(0,c.bO)(h,n.url,p)).data:{},b=await async function(e,t){const{layers:r,tables:a}=e,n=[...r??[],...a??[]];if(!n.length)return;const s=new Set,l=[];for(const{layerType:i}of n){const e=i??"ArcGISFeatureLayer";if(s.has(e))continue;s.add(e);const r=t[(0,c.K8)(e)];l.push(r())}const o=await Promise.all(l),u=new Map;return Array.from(s).forEach((e,t)=>{u.set(e,o[t])}),e=>{let{layerType:t}=e;const r=t??"ArcGISFeatureLayer";return u.get(r)}}(h,i)||b;const{provider:r,preferredHost:a}=await async function(e,t){const{layersJSON:r,preferredHost:a}=await(0,s.Q)(e,t);if(!r)return{provider:null,preferredHost:a};const n=[...r.layers,...r.tables];return{provider:e=>n.find(t=>t.id===e.id),preferredHost:a}}(n.url,{customParameters:t,loadContext:p});return(0,o.Gh)(n,a),await m(e,b,b,h,i,r)}return"Scene Service"===u&&n.url&&(h=await(0,c.nu)(n,h,p)),(0,c.XH)(h)>0?await m(e,b,null,h,i):await async function(e,t,r){const{portalItem:a}=e;if(!a?.url)return;const n=await(0,d.V)(a.url);n&&m(e,t,null,{layers:n.layers?.map(c._r),tables:n.tables?.map(c._r)},r)}(e,b,i)}(e,r)}(r,h,e);u&&"media"!==r.type&&r.read({url:u},h);const b=new l.v,{data:g,preferredHost:L}=await w(e,b,t);return u=n.url,"isUrlHostModified"in r&&(L?r.applyPreferredHost({preferredHost:L}):r.applyHostFromPortalItem()),g&&r.read(g,h),r.resourceReferences={portalItem:n,paths:h.readResourcePaths??[]},"subtype-group"!==r.type&&r.read({title:f},h),(0,p.L)(r,h)}(e,t)}async function m(e,t,r,a,n,s){let l=a.layers||[];const o=a.tables||[];if("Feature Collection"===e.portalItem?.type?(l.forEach((e,t)=>{e.id=t,"Table"===e?.layerDefinition?.type&&o.push(e)}),l=l.filter(e=>"Table"!==e?.layerDefinition?.type)):(l.reverse(),o.reverse()),l.forEach(r=>{const n=s?.(r);if(n||!s){const s=h(e,t(r),a,r,n);e.add(s)}}),o.length){const t=r?null:await n.FeatureLayer();o.forEach(n=>{const l=s?.(n);if(l||!s){const s=h(e,r?r(n):t,a,n,l);e.tables.add(s)}})}}function h(e,t,r,a,n){const s=e.portalItem,l={portalItem:s.clone(),layerId:a.id};null!=a.url&&(l.url=a.url);const o=new t(l);if("sourceJSON"in o&&(o.sourceJSON=n),"subtype-group"!==o.type&&"catalog"!==o.type&&(o.sublayerTitleMode="service-name"),"Feature Collection"===s.type){const e={origin:"portal-item",portal:s.portal||u.A.getDefault()};o.read(a,e);const t=r.showLegend;null!=t&&o.read({showLegend:t},e)}return o}async function w(e,t,r){if(!1===e.supportsData)return{data:void 0};const a=e.instance,s=a.portalItem;if(!s)return{data:void 0};let l=null;try{l=await s.fetchData("json",r)}catch(u){}if(function(e){return"stream"!==e.type&&"layerId"in e}(a)){let e=null;const{count:r,preferredHost:u}=await async function(e,t,r){if(t?.layers&&t?.tables)return{count:(0,c.XH)(t)};const a=(0,n.qg)(e.url);if(!a)return{count:1};const s=a.url.path,l=await r.fetchServiceMetadata(s,{customParameters:(0,c.pJ)(t)?.customParameters}).catch(()=>null);return{count:(t?.layers?.length??l?.layers?.length??0)+(t?.tables?.length??l?.tables?.length??0),preferredHost:(0,o.OP)(e)?(0,o.G$)():null}}(s,l,t);if((0,o.Gh)(s,u),(l?.layers||l?.tables)&&r>0){if(null==a.layerId){const e=(0,c.l)(a.type),t=e?.length?(0,c.Ju)(l,e)[0]:(0,c.pJ)(l);t&&(a.layerId=t.id)}e=function(e,t){const{layerId:r}=t,a=e.layers?.find(e=>e.id===r)||e.tables?.find(e=>e.id===r);return a&&function(e,t){const r="layerType"in e&&e.layerType,{type:a}=t;return!("feature"===a&&r&&"ArcGISFeatureLayer"!==e.layerType||"catalog"===a&&!r||"oriented-imagery"===a&&!r||"subtype-group"===a&&!r)}(a,t)?a:null}(l,a),"OrientedImageryLayer"===e?.layerType&&"oriented-imagery"===a.type&&a.supportedSourceTypes.add("Feature Layer"),e&&null!=l.showLegend&&(e.showLegend=l.showLegend)}return r>1&&"sublayerTitleMode"in a&&"service-name"!==a.sublayerTitleMode&&(a.sublayerTitleMode="item-title-and-service-name"),{data:e,preferredHost:u}}return{data:l}}},77491:(e,t,r)=>{r.d(t,{v:()=>n});var a=r(67061);class n{constructor(){this._serviceMetadatas=new Map,this._itemDatas=new Map}async fetchServiceMetadata(e,t){const r=this._serviceMetadatas.get(e);if(r)return r;const n=await(0,a.V)(e,t);return this._serviceMetadatas.set(e,n),n}async fetchItemData(e){const{id:t}=e;if(!t)return null;const{_itemDatas:r}=this;if(r.has(t))return r.get(t);const a=await e.fetchData();return r.set(t,a),a}async fetchCustomParameters(e,t){const r=await this.fetchItemData(e);return r&&"object"==typeof r&&(t?t(r):r.customParameters)||null}}}}]);
//# sourceMappingURL=73814.6926d9f9.chunk.js.map